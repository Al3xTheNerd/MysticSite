{% extends "core_layout.html" %}
{% block content %}
<script src="{{url_for('static', filename='javascript/html2canvas.js')}}"></script>
    <div class="row gx-3 gy-3">
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 col-xl-4 col-xxl-3">
            <div class="give-preview-text-outer">
                <div class="give-preview-text w-100">
                    <div class="give-preview-text-inner">
                        <form>
                            <div class="">
                                <textarea class="form-control" id="rawData" rows="20"></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 col-xl-4 col-xxl-3">
            <div class="give-preview-text-outer" id="screenshotMarker">
                <div class="give-preview-text w-100">
                    <div class="give-preview-text-inner text-start" id="itemPreview">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 col-xl-4 col-xxl-3">
            <div class="give-preview-text-outer">
                <div class="give-preview-text w-100">
                    <div class="give-preview-text-inner">
                        <form method="post" action="">
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="CrateSelectEdit">Crate</label>
                                <select name='Crate' class="form-select" id="CrateSelectEdit">
                                    {% if currentCrates is none %}
                                    <option value="">Create a new Crate First!</option>
                                    {% else %}
                                    {% for id, details in currentCrates.items() %}
                                    <option value="{{ id }}">{{ details["CrateName"] }}</option>
                                    {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="PrimaryTagGroup">Primary Tag</label>
                                <select name='PrimaryTag' class="form-select" id="PrimaryTagGroup">
                                    <option value="">None</option>
                                    {% for tag in validTags %}
                                    <option value="{{ tag }}">{{ tag }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="SecondaryTagGroup">Secondary Tag</label>
                                <select name='SecondaryTag' class="form-select" id="SecondaryTagGroup">
                                    <option value="">None</option>
                                    {% for tag in validTags %}
                                    <option value="{{ tag }}">{{ tag }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="TertiaryTagGroup">Tertiary Tag</label>
                                <select name='TertiaryTag' class="form-select" id="TertiaryTagGroup">
                                    <option value="">None</option>
                                    {% for tag in validTags %}
                                    <option value="{{ tag }}">{{ tag }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="QuaternaryTagGroup">Quaternary Tag</label>
                                <select name='QuaternaryTag' class="form-select" id="QuaternaryTagGroup">
                                    <option value="">None</option>
                                    {% for tag in validTags %}
                                    <option value="{{ tag }}">{{ tag }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="QuinaryTagGroup">Quinary Tag</label>
                                <select name='QuinaryTag' class="form-select" id="QuinaryTagGroup">
                                    <option value="">None</option>
                                    {% for tag in validTags %}
                                    <option value="{{ tag }}">{{ tag }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" name='WinPercentage' id="WinPercentageGroup"
                                    placeholder="Win Percentage">
                                <label for="WinPercentageGroup">Win Percentage</label>
                            </div>
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" name='Rarity' id="RarityGroup"
                                    placeholder="Rarity">
                                <label for="RarityGroup">Rarity</label>
                            </div>
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" name='RarityHTML' id="RarityHTMLGroup"
                                    placeholder="Rarity HTML">
                                <label for="RarityHTMLGroup">Rarity HTML</label>
                            </div>
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" name='ItemName' id="ItemNameGroup"
                                    placeholder="Item Name">
                                <label for="ItemNameGroup">Item Name</label>
                            </div>
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" name='ItemNameHTML' id="ItemNameHTMLGroup"
                                    placeholder="Item Name HTML">
                                <label for="ItemNameHTMLGroup">Item Name HTML</label>
                            </div>
                            <div class="form-floating mb-3">
                                <textarea class="form-control" name='Notes' placeholder="Item Notes" id="NotesGroup"
                                    style="height: 100px"></textarea>
                                <label for="NotesGroup">Notes</label>
                            </div>
                            <input type='text' name="RawData" id="RawData" hidden>
                            <input type='text' name="HumanData" id="HumanData" hidden>
                            <input type='text' name="HTMLData" id="HTMLData" hidden>

                            <button class="btn btn-primary mb-1" type="submit">Add to DB!</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>




    </div>

</div>
<script>
    var rawDataTextarea = document.getElementById("rawData");
    if (rawDataTextarea.addEventListener) {
        rawDataTextarea.addEventListener('input', function () {
            UpdatePreview();
        }, false);
    }
    const validTags = {{ validTags | tojson }};

    /* Converts the silly minecraft types to my own more easily usable ones. */
    const EnchantmentsList = {
        // Vanilla
        "aqua_affinity": "Aqua Affinity",
        "bane_of_arthropods": "Bane of Arthropods",
        "binding_curse": "Curse of Binding",
        "blast_protection": "Blast Protection",
        "breach": "Breach",
        "channeling": "Channeling",
        "density": "Density",
        "depth_strider": "Depth Strider",
        "efficiency": "Efficiency",
        "feather_falling": "Feather Falling",
        "fire_aspect": "Fire Aspect",
        "fire_protection": "Fire Protection",
        "flame": "Flame",
        "fortune": "Fortune",
        "frost_walker": "Frost Walker",
        "impaling": "Impaling",
        "infinity": "Infinity",
        "knockback": "Knockback",
        "looting": "Looting",
        "loyalty": "Loyalty",
        "luck_of_the_sea": "Luck of the Sea",
        "lure": "Lure",
        "mending": "Mending",
        "multishot": "Multishot",
        "piercing": "Piercing",
        "power": "Power",
        "projectile_protection": "Projectile Protection",
        "protection": "Protection",
        "punch": "Punch",
        "quick_charge": "Quick Charge",
        "respiration": "Respiration",
        "riptide": "Riptide",
        "sharpness": "Sharpness",
        "silk_touch": "Silk Touch",
        "smite": "Smite",
        "soul_speed": "Soul Speed",
        "sweeping_edge": "Sweeping Edge",
        "swift_sneak": "Swift Sneak",
        "thorns": "Thorns",
        "unbreaking": "Unbreaking",
        "vanishing_curse": "Curse of Vanishing",
        "wind_burst": "Wind Burst",
        "flame_walker": "Flame Walker",

        // MysticMC
        "thrifty": "Thrifty",
        "tunnel": "Tunnel",
        "smelter": "Smelter",

        // BlossomCraft
        "sonic" : "Sonic",
        "ice_aspect" : "Ice Aspect",
        "saturation" : "Saturation",
        "ender_bow" : "Ender Bow",
        "haste" : "Haste",
        "exp_hunter" : "Exp Hunter",
        "rage": "Rage",
        "wither" : "Wither",
        "replanter" : "Replanter"
    };

    const EnchantmentsLevelOneMaxList = [
        "mending", 
        "vanishing_curse", 
        "aqua_affinity", 
        "binding_curse", 
        "channeling",
        "flame", 
        "infinity", 
        "multishot", 
        "silk_touch",

        // MysticMC
        "smelter", 
        "flame_walker",

        // BlossomCraft
        "ender_bow",
        "rage",
        "replanter"
    ];

    const ColorCodes = {
        "black": "mc-black",
        "dark_blue": "mc-dark-blue",
        "dark_green": "mc-dark-green",
        "dark_aqua": "mc-dark-aqua",
        "dark_red": "mc-dark-red",
        "dark_purple": "mc-dark-purple",
        "gold": "mc-gold",
        "gray": "mc-gray",
        "dark_gray": "mc-dark-gray",
        "blue": "mc-blue",
        "green": "mc-green",
        "aqua": "mc-aqua",
        "red": "mc-red",
        "light_purple": "mc-light-purple",
        "yellow": "mc-yellow",
        "white": "mc-white"
    };



    function convertEnchantmentsToHTML(enchantments, bypass = false) {
        return Object.entries(enchantments).reduce((acc, [enchant, level]) => {
            let name = enchant.replace("minecraft:", "");
            if (!bypass && name === "feather_falling" && level === 6) return acc;

            let label = EnchantmentsList[name] || name;
            let display = EnchantmentsLevelOneMaxList.includes(name) ? label : `${label} ${level}`;

            if (!EnchantmentsList[name]) console.warn(`Unknown enchantment encountered: ${name} ${level}`);

            acc.push(`<span class=\"mc-gray\">${display}</span>`);
            return acc;
        }, []);
    }

    function convertEnchantmentsToHumanReadable(enchantments, bypass = false) {
        return Object.entries(enchantments).reduce((acc, [enchant, level]) => {
            let name = enchant.replace("minecraft:", "");
            if (!bypass && name === "feather_falling" && level === 6) return acc;

            let label = EnchantmentsList[name] || name;
            let display = EnchantmentsLevelOneMaxList.includes(name) ? label : `${label} ${level}`;

            if (!EnchantmentsList[name]) console.warn(`Unknown enchantment encountered: ${name} ${level}`);

            acc.push(display);
            return acc;
        }, []);
    }

    function convertItemTypes(itemType) {
        const itemTypesToCheck = [
            "helmet", "chestplate", "leggings", "boots", "elytra", "pickaxe",
            "axe", "hoe", "shovel", "rod", "sword", "crossbow", "bow", "trident", "mace"
        ];

        const cleanType = itemType.replace("minecraft:", "");

        for (const type of validTags) {
            if (type === "rod" && cleanType === "fishing_rod") return "rod";
            if (type === "rod" && cleanType !== "fishing_rod") continue;
            if (cleanType.includes(type.toLowerCase())) return type;
        }

        return null;
    }

    function extractWinChanceFromLore(ItemLoreHuman) {
        for (const line of ItemLoreHuman) {
            if (line.includes("Win Chance: ")) {
                return line.replace("Win Chance: ", "").replace("%", "");
            }
        }
        return null;
    }
    function extractRarityFromLore(ItemLoreHuman) {
        for (const line of ItemLoreHuman) {
            if (line.includes("Rarity: ")) {
                return line.replace("Rarity: ", "");
            }
        }
        return null;
    }

    function detectInfiniteBlock(ItemLoreHTML, ItemNameHuman) {
        let InfiniteBlock = 0;
        for (const line of ItemLoreHTML) {
            if (line.toLowerCase().includes("infinite")) {
                InfiniteBlock = 1;
            }
        }
        if ((ItemNameHuman.toLowerCase().includes("infinite") || ItemNameHuman.toLowerCase().includes("paint")) &&
            ItemNameHuman !== "✦ Quest - PAINT CYCLER ✦") {
            InfiniteBlock = 1;
        }
        return InfiniteBlock;
    }
    function takeScreenshot() {
        const targetElement = document.getElementById('screenshotMarker');

        html2canvas(targetElement).then(canvas => {
            const imageDataURL = canvas.toDataURL('image/png');

            // Display the captured image
            const img = document.createElement('img');
            img.src = imageDataURL;
            document.body.appendChild(img);

            // Optionally, trigger download
             const link = document.createElement('a');
             link.href = imageDataURL;
             link.download = 'item.png';
             link.click();
             link.remove()
        });
    }
    function detectItemFormat(data) {
        if (typeof data.id === "string" && data.components) {
            return "new";
        } else if (data.components && typeof data.components === "object") {
            return "old";
        } else {
            return "unknown";
        }
    }

    function normalizeItemFormat(data) {
    // Old format already has components
    if (data.components) return data;

    // New format → convert to old-style structure
    const components = {};

    if (data.display_name) {
        components["minecraft:custom_name"] = data.display_name;
    }
    if (Array.isArray(data.lore)) {
        components["minecraft:lore"] = data.lore;
    }
    if (data.enchantments) {
        components["minecraft:enchantments"] = { levels: data.enchantments };
    }
    if (data.unbreakable) {
        components["minecraft:unbreakable"] = true;
    }

    return {
        id: data.id || "minecraft:unknown",
        count: data.count || 1,
        components
    };
}

    // Convert Minecraft text component to HTML (handles old & new formats)
    function convertMCLineToHTML(line) {
        if (typeof line === "string") {
            try { line = JSON.parse(line); } catch { return line; }
        }

        if (!line.extra || !Array.isArray(line.extra)) {
            return line.text || "";
        }

        let html = "";

        for (const part of line.extra) {
            let partText = "";

            if (part.text) partText = part.text;
            else if (part.extra) partText = convertMCLineToHTML(part);
            if (partText == "") {partText = "&nbsp;"}
            let styles = "";
            let colorClass = "";
            if (part.color && ColorCodes[part.color]) {
                colorClass += ColorCodes[part.color];
            } else {
                if (part.color) styles += `color:${part.color};`;
            }
            
            if (part.bold) styles += "font-weight:bold;";
            if (part.italic) styles += "font-style:italic;";
            if (part.underlined) styles += "text-decoration:underline;";

            if (part.obfuscated) partText = `<span class="mc-obfuscated">${partText}</span>`;

            html += `<span class="${colorClass}" style="${styles}">${partText}</span>`;
        }

        return html;
    }

    // Convert Minecraft text component to plain human-readable text
    function convertMCLineToHumanReadable(line) {
        if (typeof line === "string") {
            try { line = JSON.parse(line); } catch { return line; }
        }

        if (!line.extra || !Array.isArray(line.extra)) {
            return line.text || "";
        }

        let text = "";
        for (const part of line.extra) {
            if (part.text) text += part.text;
            else if (part.extra) text += convertMCLineToHumanReadable(part);
        }
        return text;
    }

    // Updated UpdatePreview function
    function UpdatePreview() {
        const rawData = JSON.parse(rawDataTextarea.value);
        const finalItemType = convertItemTypes(rawData.id);
        
        const itemName = rawData.components["minecraft:custom_name"];
        const finalItemNameHTML = convertMCLineToHTML(itemName);
        const finalItemNameHuman = convertMCLineToHumanReadable(itemName).replaceAll("§", "").replaceAll("&", "");

        let EnchantmentsHTML = [];
        let EnchantmentsHuman = [];
        if ("minecraft:enchantments" in rawData.components) {
            const enchantments = rawData.components["minecraft:enchantments"].levels;
            EnchantmentsHTML = convertEnchantmentsToHTML(enchantments);
            EnchantmentsHuman = convertEnchantmentsToHumanReadable(enchantments);
        }

        let ItemLoreHTML = [];
        let ItemLoreHuman = [];
        if (rawData.components["minecraft:lore"]) {
            for (const loreLine of rawData.components["minecraft:lore"]) {
                ItemLoreHTML.push(convertMCLineToHTML(loreLine));
                ItemLoreHuman.push(convertMCLineToHumanReadable(loreLine).replaceAll("§", "").replaceAll("&", ""));
            }
        }

        const Unbreakable = "minecraft:unbreakable" in rawData.components;

        // Build final HTML preview
        let finalHTML = `<div>${finalItemNameHTML}</div>`;
        for (const enchant of EnchantmentsHTML) finalHTML += `<div>${enchant}</div>`;
        for (const line of ItemLoreHTML) finalHTML += `<div>${line || "&nbsp;"}</div>`;
        if (Unbreakable) finalHTML += `<div><span class="mc-blue">Unbreakable</span></div>`;
        finalHTML += `<div><span class='mc-dark-gray'>${rawData.id}</span></div>`;

        if (detectInfiniteBlock(ItemLoreHuman, finalItemNameHuman) === 1) finalItemType = "Infinite";

        // Build human-readable text
        let finalHuman = `${finalItemNameHuman} `;
        finalHuman += EnchantmentsHuman.join(" ");
        finalHuman += ItemLoreHuman.join(" ");
        if (Unbreakable) finalHuman += " Unbreakable";

        WinPercentage = extractWinChanceFromLore(ItemLoreHuman);
        RarityHuman = extractRarityFromLore(ItemLoreHuman);
        RarityHTML = extractRarityFromLore(ItemLoreHTML);

        // Update HTML elements
        document.getElementById("itemPreview").innerHTML = finalHTML;
        if (finalItemType) document.getElementById('PrimaryTagGroup').value = finalItemType;
        document.getElementById('WinPercentageGroup').value = WinPercentage;
        document.getElementById('RarityGroup').value = RarityHuman;
        document.getElementById('RarityHTMLGroup').value = RarityHTML;
        document.getElementById('ItemNameGroup').value = finalItemNameHuman;
        document.getElementById('ItemNameHTMLGroup').value = finalItemNameHTML;
        document.getElementById('RawData').value = JSON.stringify(rawData);
        document.getElementById('HumanData').value = finalHuman;
        document.getElementById('HTMLData').value = finalHTML;

        // takeScreenshot()
    }




</script>


{% endblock %}